const timelineContainer=document.getElementById("timelineContainer"),searchInput=document.getElementById("searchInput"),noResults=document.getElementById("noResults"),modal=document.getElementById("detailModal"),modalContent=document.getElementById("modalContent"),modalBackdrop=document.getElementById("modalBackdrop"),modalHeader=document.getElementById("modalHeader"),modalName=document.getElementById("modalName"),modalDate=document.getElementById("modalDate"),modalStory=document.getElementById("modalStory"),modalSource=document.getElementById("modalSource"),modalLogic=document.getElementById("modalLogic"),modalEpoch=document.getElementById("modalEpoch"),langLoader=document.getElementById("lang-loader"),htmlRoot=document.documentElement,contactForm=document.getElementById("contactForm"),contactSuccess=document.getElementById("contactSuccess"),languageStorageKey="preferredLanguage",state={filter:"all",searchTerm:"",anchorId:null,modalOpenId:null,scrollTop:0};let renderRafId=null;const epochNames={"epoch-1":{ar:"ÿßŸÑŸäŸÖŸÜ ŸàÿßŸÑÿ¨ÿ∞Ÿàÿ±",en:"Yemen & Origins",es:"Yemen y or√≠genes"},"epoch-2":{ar:"ÿßŸÑÿπŸáÿØ ÿßŸÑŸÜÿ®ŸàŸä",en:"Prophetic Era",es:"√âpoca prof√©tica"},"epoch-3":{ar:"ÿßŸÑÿ£ŸÜÿØŸÑÿ≥",en:"Al-Andalus",es:"Al-√Åndalus"},"epoch-4":{ar:"ÿßŸÑŸáÿ¨ÿ±ÿ©",en:"Migration",es:"Migraci√≥n"},"epoch-5":{ar:"ŸÑŸäÿ®Ÿäÿß",en:"Libya",es:"Libia"}};function getData(){return window.FamilyTreeData||{meta:{},nodes:[]}}function getLang(){return(getData().meta?.lang||"ar").toLowerCase()}function initializeUI(){const e=getData(),t=e.meta?.dir||"rtl",o=e.meta?.lang||"ar";htmlRoot.setAttribute("lang",o),htmlRoot.setAttribute("dir",t),document.body.style.direction=t,"rtl"===t?(document.body.classList.remove("ltr-mode"),document.body.classList.add("rtl-mode")):(document.body.classList.remove("rtl-mode"),document.body.classList.add("ltr-mode"));document.querySelectorAll(".flex-row-responsive").forEach(e=>{e.style.flexDirection="rtl"===t?"row-reverse":"row"}),updateLanguageSelect(o)}function getEpochName(e){const t=getLang();return epochNames[e]?.[t]||epochNames[e]?.ar||e}function applyTranslations(){const{translations:e={}}=getData();document.querySelectorAll("[data-i18n]").forEach(t=>{const o=t.getAttribute("data-i18n");if(!o)return;const a=e[o];"string"==typeof a&&(t.innerHTML=a)}),document.querySelectorAll("[data-i18n-placeholder]").forEach(t=>{const o=t.getAttribute("data-i18n-placeholder");if(!o)return;const a=e[o];"string"==typeof a&&t.setAttribute("placeholder",a)}),document.querySelectorAll("[data-i18n-title]").forEach(t=>{const o=t.getAttribute("data-i18n-title");if(!o)return;const a=e[o];"string"==typeof a&&t.setAttribute("title",a)}),document.querySelectorAll("[data-i18n-alt]").forEach(t=>{const o=t.getAttribute("data-i18n-alt");if(!o)return;const a=e[o];"string"==typeof a&&t.setAttribute("alt",a)})}function renderPoemSections(){const{translations:e={}}=getData();document.querySelectorAll("[data-i18n-lines]").forEach(t=>{const o=t.getAttribute("data-i18n-lines");if(!o)return;const a=e[o];if(!a)return void(t.innerHTML="");const n=Array.isArray(a)?a:[a];t.innerHTML="",n.forEach(e=>{const o=document.createElement("p");if(o.className="poem-line","string"==typeof e&&e.includes("...")){const t=e.split("..."),a=t.shift()?.trim()||"",n=t.join("...").trim();o.innerHTML=`\n                    <span class="verse-part">${a}</span>\n                    <span class="verse-divider">‚Ä¶</span>\n                    <span class="verse-part">${n}</span>\n                `}else o.textContent=e;t.appendChild(o)})})}function updateSearchPlaceholder(){const{i18n:e,translations:t}=getData();searchInput&&(e?.search_placeholder||t?.search_placeholder)&&(searchInput.placeholder=t?.search_placeholder||e.search_placeholder)}function renderTimeline(){return new Promise(e=>{renderRafId&&cancelAnimationFrame(renderRafId),renderRafId=requestAnimationFrame(()=>{const{nodes:t}=getData();timelineContainer.innerHTML="";const o=t.filter(e=>{const t="all"===state.filter||e.type===state.filter,o=!state.searchTerm||e.name.toLowerCase().includes(state.searchTerm.toLowerCase());return t&&o});if(0===o.length)return noResults.classList.remove("hidden"),void e();noResults.classList.add("hidden");const a="rtl"===(getData().meta?.dir||"rtl"),n=document.createDocumentFragment();o.forEach((e,t)=>{const o=document.createElement("div");o.className=`bg-white rounded-lg p-5 shadow-sm hover:shadow-md border-r-4 ${e.type}-border flex justify-between items-center cursor-pointer transition-all animate-fade-up`,o.style.animationDelay=.05*t+"s",o.dataset.nodeId=e.id;let d="text-slate-400";"epoch-1"===e.type?d="epoch-1-text":"epoch-2"===e.type?d="epoch-2-text":"epoch-3"===e.type?d="epoch-3-text":"epoch-4"===e.type?d="epoch-4-text":"epoch-5"===e.type&&(d="epoch-5-text");const l=e.badge||"";let s="badge-historical";(l.includes("ŸÖŸàÿ´ŸÇ")||l.includes("ÿµÿ≠ÿßÿ®Ÿä")||l.includes("ŸàŸÇŸÅ")||l.toLowerCase().includes("documented"))&&(s="badge-verified");const c=a?"absolute -right-[43px]":"absolute -left-[43px]",i=a?"md:pr-4":"md:pl-4",r=e.doc_img?`\n            <button onclick="event.stopPropagation(); showDocumentModal('${e.doc_img}', '${e.doc_title}', '${e.doc_desc_key}')"\n                class="mt-3 w-full py-1 px-3 bg-[#d4af37]/10 border border-[#d4af37] text-[#8d6e63] text-xs font-bold rounded hover:bg-[#d4af37] hover:text-white transition flex items-center justify-center gap-2">\n                <span>üìú</span> <span>${getData().translations?.btn_view_doc||"View Document 1002 AH"}</span>\n            </button>\n          `:"";o.innerHTML=`\n          <div class="md:w-full ${i} relative">\n            <div class="hidden md:block ${c} top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-2 border-white shadow bg-current ${d}"></div>\n            <div class="flex items-center gap-2 mb-1">\n              <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${e.name.split(".")[0]}</span>\n            </div>\n            <h3 class="font-bold text-lg text-slate-800">${e.name.split(". ")[1]||e.name}</h3>\n            <div class="flex flex-wrap gap-2 mt-2">\n              <span class="text-xs font-mono bg-slate-50 px-2 py-1 rounded border border-slate-100 ${d}">üìÖ ${e.date}</span>\n              <span class="text-[10px] font-bold px-2 py-1 rounded ${s}">${l}</span>\n            </div>\n            ${r}\n          </div>\n          <div class="text-slate-200 text-2xl transform group-hover:scale-110 transition">üëÅÔ∏è</div>\n        `,o.addEventListener("click",()=>openModal(e)),n.appendChild(o)}),timelineContainer.appendChild(n),e()})})}function openModal(e){const{translations:t={}}=getData(),o=document.getElementById("modalDocBody"),a=document.getElementById("modalDefaultBody"),n=document.getElementById("modalDocImage"),d=document.getElementById("modalDocTranscription"),l=document.getElementById("modalDateRow");a&&a.classList.remove("hidden"),o&&o.classList.add("hidden"),n&&(n.src=""),d&&(d.innerText=""),l&&l.classList.remove("hidden"),modalName.innerText=e.name,modalDate.innerHTML=e.date,modalStory.innerText="--"===e.story?t.modal_story_fallback||"ÿ≠ŸÑŸÇÿ© ŸàÿµŸÑ ŸÅŸä ÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑŸÜÿ≥ÿ® ÿßŸÑŸÖÿ™Ÿàÿßÿ™ÿ±ÿ©.":e.story,modalSource.innerText=e.src,modalLogic.innerText="--"===e.logic?t.modal_logic_fallback||"ÿ™ÿ≥ŸÑÿ≥ŸÑ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ£ÿ¨ŸäÿßŸÑ.":e.logic,modalEpoch.innerText=getEpochName(e.type),state.modalOpenId=e.id,modalHeader.className="p-6 text-white rounded-t-2xl flex justify-between items-start relative overflow-hidden transition-colors duration-300","epoch-1"===e.type?modalHeader.classList.add("bg-[#8D6E63]"):"epoch-2"===e.type?modalHeader.classList.add("bg-[#4CAF50]"):"epoch-3"===e.type?modalHeader.classList.add("bg-[#C62828]"):"epoch-4"===e.type?modalHeader.classList.add("bg-[#7E57C2]"):"epoch-5"===e.type&&modalHeader.classList.add("bg-[#1976D2]"),modal.classList.remove("hidden"),setTimeout(()=>{modalBackdrop.classList.remove("opacity-0"),modalContent.classList.remove("scale-95","opacity-0"),modalContent.classList.add("scale-100","opacity-100")},10)}function closeModal(){modalBackdrop.classList.add("opacity-0"),modalContent.classList.remove("scale-100","opacity-100"),modalContent.classList.add("scale-95","opacity-0"),setTimeout(()=>modal.classList.add("hidden"),300)}function showDocumentModal(e,t,o){const{translations:a={}}=getData(),n=document.getElementById("modalDocBody"),d=document.getElementById("modalDefaultBody"),l=document.getElementById("modalDocImage"),s=document.getElementById("modalDocTranscription"),c=document.getElementById("modalDateRow");if(!(n&&d&&l&&s))return;l.src=e||"";const i=a[t]||t||"",r=a[o]||o||"";modalName.innerText=i,c&&c.classList.add("hidden"),modalStory.innerText="",modalSource.innerText="",modalLogic.innerText="",s.innerText=r,modalHeader.className="p-6 text-white rounded-t-2xl flex justify-between items-start relative overflow-hidden transition-colors duration-300",modalHeader.classList.add("bg-[#d4af37]"),d.classList.add("hidden"),n.classList.remove("hidden"),modal.classList.remove("hidden"),setTimeout(()=>{modalBackdrop.classList.remove("opacity-0"),modalContent.classList.remove("scale-95","opacity-0"),modalContent.classList.add("scale-100","opacity-100")},10)}function openDocModal(e,t,o){const a=document.getElementById("docModal"),n=document.getElementById("docBackdrop"),d=document.getElementById("docContent"),l=document.getElementById("docTitle"),s=document.getElementById("docImage"),c=document.getElementById("docDesc");a&&n&&d&&l&&s&&c&&(l.innerText=t||"",s.src=e||"",c.innerText=o||"",a.classList.remove("hidden"),setTimeout(()=>{n.classList.remove("opacity-0"),d.classList.remove("scale-95","opacity-0"),d.classList.add("scale-100","opacity-100")},10))}function closeDocModal(){const e=document.getElementById("docModal"),t=document.getElementById("docBackdrop"),o=document.getElementById("docContent");e&&t&&o&&(t.classList.add("opacity-0"),o.classList.remove("scale-100","opacity-100"),o.classList.add("scale-95","opacity-0"),setTimeout(()=>e.classList.add("hidden"),300))}function switchTab(e){["tree","figures","library","poem","author"].forEach(e=>{document.getElementById(`view-${e}`).classList.add("hidden"),document.getElementById(`tab-${e}`).classList.remove("active","text-white/90"),document.getElementById(`tab-${e}`).classList.add("text-white/60")}),document.getElementById(`view-${e}`).classList.remove("hidden"),document.getElementById(`tab-${e}`).classList.add("active","text-white/90"),document.getElementById(`tab-${e}`).classList.remove("text-white/60")}function filterTimeline(e,t){state.filter={all:"all",yemen:"epoch-1",prophet:"epoch-2",andalus:"epoch-3",migration:"epoch-4",libya:"epoch-5"}[e]||e,document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.remove("active","bg-amber-500","text-white","shadow-lg","shadow-amber-500/20"),e.classList.add("bg-slate-800/50","text-slate-400","hover:bg-slate-700","border","border-slate-700/50")}),t&&(t.classList.remove("bg-slate-800/50","text-slate-400","hover:bg-slate-700","border","border-slate-700/50"),t.classList.add("active","bg-amber-500","text-white","shadow-lg","shadow-amber-500/20")),renderTimeline()}async function changeLanguage(e){if(e!==getLang()){captureAnchorState(),langLoader.classList.add("visible");try{await loadLanguageScript(e),await initializeWebsite(e)}catch(e){console.error("Language switch failed:",e)}finally{langLoader.classList.remove("visible")}}}function updateLanguageSelect(e){const t=document.getElementById("lang-select");t&&(t.value=e)}function captureAnchorState(){state.scrollTop=window.scrollY||document.documentElement.scrollTop||0;const e=Array.from(document.querySelectorAll("[data-node-id]"));if(!e.length)return;const t=window.innerHeight/2;let o=null,a=1/0;e.forEach(e=>{const n=e.getBoundingClientRect(),d=n.top+n.height/2,l=Math.abs(d-t);l<a&&(a=l,o=e)}),state.anchorId=o?.dataset?.nodeId||null}function restoreAnchorState(){if(state.anchorId){const e=document.querySelector(`[data-node-id="${state.anchorId}"]`);if(e){const t=e.getBoundingClientRect(),o=window.scrollY+t.top-window.innerHeight/2+t.height/2;return void window.scrollTo({top:o,behavior:"auto"})}}window.scrollTo({top:state.scrollTop,behavior:"auto"})}function loadLanguageScript(e){return new Promise((t,o)=>{const a=document.getElementById("family-tree-data");a&&a.remove();const n=document.createElement("script");n.id="family-tree-data",n.src=`data/data_${e}.min.js?t=${Date.now()}`,n.onload=t,n.onerror=o,document.body.appendChild(n)})}async function initializeWebsite(e){try{localStorage.setItem(languageStorageKey,e)}catch(e){console.warn("Unable to save language preference",e)}if(initializeUI(),applyTranslations(),renderPoemSections(),updateSearchPlaceholder(),await renderTimeline(),restoreAnchorState(),state.modalOpenId){const e=getData().nodes.find(e=>e.id===state.modalOpenId);e&&openModal(e)}}function resolveInitialLanguage(){let e=null;try{e=localStorage.getItem(languageStorageKey)}catch(e){console.warn("Unable to read language preference",e)}if(e)return e;const t=(navigator.language||"").toLowerCase();return t.startsWith("pl")?"pl":t.startsWith("tr")?"tr":t.startsWith("es")?"es":t.startsWith("en")?"en":"ar"}document.addEventListener("keydown",e=>{if("Escape"===e.key){modal.classList.contains("hidden")||closeModal();const e=document.getElementById("docModal");e&&!e.classList.contains("hidden")&&closeDocModal()}}),modalBackdrop?.addEventListener("click",()=>{modal.classList.contains("hidden")||closeModal()});const docBackdrop=document.getElementById("docBackdrop");docBackdrop?.addEventListener("click",()=>{const e=document.getElementById("docModal");e&&!e.classList.contains("hidden")&&closeDocModal()});const closeButton=document.getElementById("modalCloseButton");closeButton&&closeButton.addEventListener("click",e=>{e.stopPropagation(),modal.classList.contains("hidden")||closeModal()});const docCloseButton=document.getElementById("docCloseButton");function loadYoutubeVideo(e){const t=e.querySelector(".youtube-container");if(!t)return;if(t.querySelector("iframe"))return;const o=document.createElement("iframe");o.width="100%",o.height="100%",o.src="https://www.youtube.com/embed/videoseries?list=PLx2j-W6hDiG6a9AAPBQgCRjG_t1Ge--dl&autoplay=1",o.title="YouTube video player",o.frameBorder="0",o.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",o.allowFullscreen=!0,t.appendChild(o),t.classList.remove("hidden")}docCloseButton&&docCloseButton.addEventListener("click",e=>{e.stopPropagation(),closeDocModal()}),searchInput?.addEventListener("input",e=>{state.searchTerm=e.target.value||"",renderTimeline()}),contactForm&&contactForm.addEventListener("submit",async e=>{e.preventDefault(),contactSuccess&&contactSuccess.classList.add("hidden");try{const e=await fetch(contactForm.action,{method:"POST",headers:{Accept:"application/json"},body:new FormData(contactForm)});e.ok?(contactForm.reset(),contactSuccess?.classList.remove("hidden")):console.error("Form submission failed",e.statusText)}catch(e){console.error("Form submission error",e)}}),document.addEventListener("DOMContentLoaded",async()=>{let e=resolveInitialLanguage();["ar","en","tr","pl","es"].includes(e)||(e="ar");const t=document.getElementById("lang-select");t&&(t.value=e),langLoader.classList.add("visible");try{await loadLanguageScript(e),await initializeWebsite(e)}catch(e){console.error("Initialization failed",e)}finally{langLoader.classList.remove("visible")}}),window.switchTab=switchTab,window.filterTimeline=filterTimeline,window.changeLanguage=changeLanguage,window.closeModal=closeModal,window.openModal=openModal,window.openDocModal=openDocModal,window.showDocumentModal=showDocumentModal,window.closeDocModal=closeDocModal,window.loadYoutubeVideo=loadYoutubeVideo;